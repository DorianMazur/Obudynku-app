name: Deploy
on:
    workflow_run:
        workflows: ['Test']
        branches: [main]
        types:
            - completed

jobs:
    test:
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        steps:
            - name: Check out repository code.
              uses: actions/checkout@v2
            - name: Install Node.js.
              uses: actions/setup-node@v2
              with:
                  node-version: '16.13'
            - name: Cache Yarn cache.
              uses: c-hive/gha-yarn-cache@v2
            - name: Install project dependencies.
              run: yarn --prefer-offline  --frozen-lockfile
            - uses: pmorelli92/github-container-registry-build-push@2.0.0
              name: Build and publish docker image
              with:
                github-push-secret: ${{secrets.GITHUB_TOKEN}}
                docker-image-tag: ${{GITHUB_SHA::7}}
                docker-image-name: ob-frontend
                dockerfile-path: ./packages/ob-frontend/Dockerfile
                build-context: ./
